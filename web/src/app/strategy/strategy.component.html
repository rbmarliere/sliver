<div *ngIf="loading" class="main" style="padding: 2vh">
  <mat-spinner></mat-spinner>
</div>

<div *ngIf="!loading" class="main container">
  <p *ngIf="!strategy.id">NEW STRATEGY</p>
  <p *ngIf="strategy.id">EDIT STRATEGY (id={{ strategy.id }})</p>

  <mat-card>
    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="updateStrategy()">
        <div class="fields" *ngIf="strategy.id">
          <p>
            <mat-slide-toggle formControlName="active">
              Active
            </mat-slide-toggle>

            <mat-slider
              formControlName="lm_ratio"
              thumbLabel
              [displayWith]="formatLabel"
              min="0"
              max="1"
              step="0.01"
            ></mat-slider>
            <label>Market Orders</label>
          </p>
          <p>
            <mat-form-field appearance="fill" *ngIf="strategy.id">
              <mat-label>Signal</mat-label>
              <mat-select formControlName="signal">
                <mat-option value="neutral"> neutral </mat-option>
                <mat-option value="buy"> buy </mat-option>
                <mat-option value="sell"> sell </mat-option>
              </mat-select>
            </mat-form-field>
          </p>

          <p>
            <mat-form-field appearance="fill">
              <mat-label>Type</mat-label>
              <mat-select formControlName="type">
                <mat-option
                  *ngFor="let type of strategyTypes"
                  [value]="type.value"
                >
                  {{ type.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </p>
        </div>
        <div class="fields">
          <p>
            <mat-form-field appearance="fill">
              <mat-label>Market</mat-label>
              <mat-select formControlName="market_id">
                <mat-option *ngFor="let market of markets" [value]="market.id">
                  {{ market.exchange_name }} - {{ market.symbol }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </p>

          <p>
            <mat-form-field appearance="fill">
              <mat-label>Timeframe</mat-label>
              <mat-select formControlName="timeframe">
                <mat-option
                  *ngFor="let timeframe of timeframes"
                  [value]="timeframe"
                >
                  {{ timeframe }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                placeholder="description"
                formControlName="description"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="refresh interval in minutes"
                formControlName="refresh_interval"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="datetime-local"
                step="any"
                placeholder="next refresh at (UTC)"
                formControlName="next_refresh"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="number of orders to insert"
                formControlName="num_orders"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="bucket interval in minutes"
                formControlName="bucket_interval"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="spread (%) to insert orders from"
                formControlName="spread"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="minimum ROI (%)"
                formControlName="stop_gain"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="stop loss (%)"
                formControlName="stop_loss"
              />
            </mat-form-field>
          </p>
        </div>

        <div class="fields" *ngIf="strategy.type === 2">
          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="intensity score threshold"
                formControlName="i_threshold"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="number"
                placeholder="polarity score threshold"
                formControlName="p_threshold"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="text"
                placeholder="tweet filter regex"
                formControlName="tweet_filter"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="text"
                placeholder="intensity model"
                formControlName="model_i"
              />
            </mat-form-field>
          </p>

          <p>
            <mat-form-field>
              <input
                matInput
                type="text"
                placeholder="polarity model"
                formControlName="model_p"
              />
            </mat-form-field>
          </p>
        </div>

        <p>
          <button mat-raised-button color="primary">Save</button>

          <button
            mat-raised-button
            *ngIf="strategy.id > 0"
            type="button"
            color="primary"
            (click)="updateSubscription(strategy)"
          >
            <span *ngIf="!strategy.subscribed">Subscribe</span>
            <span *ngIf="strategy.subscribed">Unsubscribe</span>
          </button>
        </p>
      </form>
    </mat-card-content>
  </mat-card>

  <div *ngIf="strategy.id && plot.data">
    <p>
      <plotly-plot
        [config]="plot.config"
        [data]="plot.data"
        [layout]="plot.layout"
        [updateOnlyWithRevision]="true"
        (relayout)="zoom($event)"
      ></plotly-plot>
    </p>

    <!-- <p class="text-center"> -->
    <!--   -- BACKTEST -- -->
    <!-- </p> -->
    <pre class="text-center">
      {{ backtest_log }}
    </pre>
  </div>
</div>
